commit c6ab7de0423c5fbc3095490e77e5c71808ccf047
Author:     sharwell <sharwell@pixelminegames.com>
AuthorDate: Wed Jun 22 16:02:58 2011 -0800
Commit:     sharwell <sharwell@pixelminegames.com>
CommitDate: Wed Jun 22 16:02:58 2011 -0800

(C# 3) Fix imports

[git-p4: depot-paths = "//depot/code/antlrcs/main/": change = 8734]

diff --git a/Antlr4.StringTemplate/TemplateGroup.cs b/Antlr4.StringTemplate/TemplateGroup.cs
index e0a3850..9e29dd5 100644
--- a/Antlr4.StringTemplate/TemplateGroup.cs
+++ b/Antlr4.StringTemplate/TemplateGroup.cs
@@ -75,7 +75,9 @@ namespace Antlr4.StringTemplate
/** Every group can import templates/dictionaries from other groups.
*  The list must be synchronized (see ImportTemplates).
*/
-        private readonly List<TemplateGroup> imports = new List<TemplateGroup>();
+        private readonly List<TemplateGroup> _imports = new List<TemplateGroup>();
+
+        private readonly List<TemplateGroup> _importsToClearOnUnload = new List<TemplateGroup>();

public readonly char delimiterStartChar = '<'; // Use <expr> by default
public readonly char delimiterStopChar = '>';
@@ -371,6 +373,14 @@ namespace Antlr4.StringTemplate
{
templates.Clear();
dictionaries.Clear();
+
+            foreach (var import in _imports)
+                import.Unload();
+
+            foreach (var import in _importsToClearOnUnload)
+                _imports.Remove(import);
+
+            _importsToClearOnUnload.Clear();
}

/** Load st from disk if dir or load whole group file if .stg file (then
@@ -388,10 +398,10 @@ namespace Antlr4.StringTemplate

protected internal virtual CompiledTemplate LookupImportedTemplate(string name)
{
-            if (imports == null)
+            if (_imports == null)
return null;

-            foreach (TemplateGroup g in imports)
+            foreach (TemplateGroup g in _imports)
{
if (Verbose)
Console.WriteLine(string.Format("checking {0} for imported {1}", g.Name, name));
@@ -683,10 +693,18 @@ namespace Antlr4.StringTemplate
/** Make this group import templates/dictionaries from g. */
public virtual void ImportTemplates(TemplateGroup g)
{
-            if (g == null)
+            ImportTemplates(g, false);
+        }
+
+        /** Make this group import templates/dictionaries from g. */
+        private void ImportTemplates(TemplateGroup group, bool clearOnUnload)
+        {
+            if (group == null)
return;

-            imports.Add(g);
+            _imports.Add(group);
+            if (clearOnUnload)
+                _importsToClearOnUnload.Add(group);
}

/** Import template files, directories, and group files.
@@ -802,7 +820,7 @@ namespace Antlr4.StringTemplate
}
else
{
-                ImportTemplates(g);
+                ImportTemplates(g, true);
}
}

@@ -1016,8 +1034,8 @@ namespace Antlr4.StringTemplate
public virtual string Show()
{
StringBuilder buf = new StringBuilder();
-            if (imports != null && imports.Count > 0)
-                buf.Append(" : " + imports);
+            if (_imports != null && _imports.Count > 0)
+                buf.Append(" : " + _imports);

foreach (string n in templates.Keys)
{
diff --git a/Antlr4.Test.StringTemplate/TestImports.cs b/Antlr4.Test.StringTemplate/TestImports.cs
index f1966b3..ad06afe 100644
--- a/Antlr4.Test.StringTemplate/TestImports.cs
+++ b/Antlr4.Test.StringTemplate/TestImports.cs
@@ -284,7 +284,7 @@ namespace Antlr4.Test.StringTemplate
{
// /randomdir/x/subdir/a and /randomdir/y/subdir/b
string dir = tmpdir;
-            string a = "a() ::= << <subdir/b()> >>\n";
+            string a = "a() ::= << </subdir/b()> >>\n";
string b = "b() ::= <<x's subdir/b>>\n";
writeFile(dir, Path.Combine("x", "subdir", "a.st"), a);
writeFile(dir, Path.Combine("y", "subdir", "b.st"), b);
@@ -303,7 +303,7 @@ namespace Antlr4.Test.StringTemplate
{
// /randomdir/x/subdir/a and /randomdir/y/subdir.stg which has a and b
string dir = tmpdir;
-            string a = "a() ::= << <subdir/b()> >>\n"; // get b imported from subdir.stg
+            string a = "a() ::= << </subdir/b()> >>\n"; // get b imported from subdir.stg
writeFile(dir, Path.Combine("x", "subdir", "a.st"), a);

string groupFile =
@@ -314,7 +314,12 @@ namespace Antlr4.Test.StringTemplate
TemplateGroup group1 = new TemplateGroupDirectory(Path.Combine(dir, "x"));
TemplateGroup group2 = new TemplateGroupDirectory(Path.Combine(dir, "y"));
group1.ImportTemplates(group2);
+
Template st = group1.GetInstanceOf("subdir/a");
+
+            Assert.IsNotNull(st);
+            Assert.IsNotNull(group1.GetInstanceOf("subdir/b"));
+
string expected = " group file: b ";
string result = st.Render();
Assert.AreEqual(expected, result);

