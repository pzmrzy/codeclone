commit 4562b3066c15e203df4cb652eec66167c26b8c9f
Author:     sharwell <sharwell@pixelminegames.com>
AuthorDate: Tue Jan 18 15:26:42 2011 -0800
Commit:     sharwell <sharwell@pixelminegames.com>
CommitDate: Tue Jan 18 15:26:42 2011 -0800

Updated MSBuild targets file for improved IntelliSense support between builds

[git-p4: depot-paths = "//depot/code/antlrcs/main/": change = 7431]

diff --git a/AntlrBuildTask/Antlr3.targets b/AntlrBuildTask/Antlr3.targets
index 211cf7f..b57c5e0 100644
--- a/AntlrBuildTask/Antlr3.targets
+++ b/AntlrBuildTask/Antlr3.targets
@@ -1,6 +1,6 @@
ï»¿<!--
[The "BSD licence"]
-   Copyright (c) 2009 Sam Harwell
+   Copyright (c) 2011 Sam Harwell
All rights reserved.

Redistribution and use in source and binary forms, with or without
@@ -28,12 +28,12 @@
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
<PropertyGroup>
<BuildSystem>MSBuild</BuildSystem>
-    <TaskVersion>3.2.0.0</TaskVersion>
+    <TaskVersion>3.3.0.7239</TaskVersion>
<TaskKeyToken>eb42632606e9261f</TaskKeyToken>
<AntlrBuildTaskAssemblyName Condition="'$(AntlrBuildTaskAssemblyName)'==''">AntlrBuildTask, Version=$(TaskVersion), Culture=neutral, PublicKeyToken=$(TaskKeyToken)</AntlrBuildTaskAssemblyName>
</PropertyGroup>

-  <PropertyGroup>
+  <!--<PropertyGroup>
<LoadTimeSensitiveTargets>
$(LoadTimeSensitiveTargets);
AntlrCompile;
@@ -48,7 +48,7 @@
AntlrCompile;
$(PrepareResourcesDependsOn)
</PrepareResourcesDependsOn>
-  </PropertyGroup>
+  </PropertyGroup>-->

<PropertyGroup>
<AntlrBuildTaskLocation Condition="'$(AntlrBuildTaskPath)'==''">$(MSBuildBinPath)</AntlrBuildTaskLocation>
@@ -84,12 +84,26 @@
</ItemGroup>

<Target Name="AntlrCompileReadGeneratedFileList">
-
<ReadLinesFromFile File="$(IntermediateOutputPath)$(AntlrGenCodeFileNames)">
<Output TaskParameter="Lines" ItemName="AntlrOutputCodeFilesList"/>
</ReadLinesFromFile>
</Target>

+  <PropertyGroup>
+    <!-- Add grammar compilation to the CoreCompileDependsOn so that the IDE inproc compilers (particularly VB)
+         can "see" the generated source files. -->
+    <CoreCompileDependsOn Condition="'$(BuildingInsideVisualStudio)' == 'true' ">
+      DesignTimeGrammarCompilation;
+      $(CoreCompileDependsOn)
+    </CoreCompileDependsOn>
+  </PropertyGroup>
+
+  <Target Name="DesignTimeGrammarCompilation">
+    <!-- Only if we are not actually performing a compile i.e. we are in design mode -->
+    <CallTarget Condition="'$(BuildingProject)' != 'true'"
+                Targets="AntlrCompile" />
+  </Target>
+
<Target Name="AntlrCompile"
DependsOnTargets="$(AntlrCompileDependsOn)"
Condition="'@(Antlr3)' != ''"
@@ -101,18 +115,25 @@
<AntlrGeneratedCodeFiles Remove="@(AntlrGeneratedCodeFiles)" />
</ItemGroup>

+    <PropertyGroup>
+      <_IntellisenseOnlyCompile>false</_IntellisenseOnlyCompile>
+      <_IntellisenseOnlyCompile Condition="'$(BuildingProject)' != 'true'">true</_IntellisenseOnlyCompile>
+    </PropertyGroup>
<AntlrClassGenerationTask
AntlrToolPath="$(AntlrToolLocation)"
BuildTaskPath="$(AntlrBuildTaskLocation)"
OutputPath="$(IntermediateOutputPath)"
Language="$(Language)"
SourceCodeFiles="@(Antlr3)"
+      ContinueOnError="$(_IntellisenseOnlyCompile)"
TokensFiles="@(AntlrTokens)">

<Output ItemName="AntlrGeneratedCodeFiles" TaskParameter="GeneratedCodeFiles" />
+      <Output ItemName="Compile" TaskParameter="GeneratedCodeFiles" />
</AntlrClassGenerationTask>

<WriteLinesToFile
+      Condition="'$(_IntellisenseOnlyCompile)' != 'true'"
File="$(IntermediateOutputPath)$(AntlrGenCodeFileNames)"
Lines="@(AntlrGeneratedCodeFiles)"
Overwrite="true"/>
@@ -123,17 +144,17 @@
Condition="'@(Antlr3)' != ''">

<ItemGroup>
-      <AntlrGeneratedCodeFiles Condition="'@(AntlrGeneratedCodeFiles)' == ''"
-                               Include="@(AntlrOutputCodeFilesList)" />
+      <Compile Condition="'@(AntlrGeneratedCodeFiles)' == ''" Include="@(AntlrOutputCodeFilesList)" />
</ItemGroup>

<ItemGroup>
-      <FileWrites Include="@(AntlrGeneratedCodeFiles);
-                           $(IntermediateOutputPath)$(AntlrGenCodeFileNames);" />
+      <_AntlrCodeGenFileWrites Condition="'@(AntlrGeneratedCodeFiles)' != ''" Include="@(AntlrGeneratedCodeFiles)" />
+      <_AntlrCodeGenFileWrites Condition="'@(AntlrGeneratedCodeFiles)' == ''" Include="@(AntlrOutputCodeFilesList)" />
</ItemGroup>

<ItemGroup>
-      <Compile Include="@(AntlrGeneratedCodeFiles)" />
+      <FileWrites Include="@(_AntlrCodeGenFileWrites);
+                           $(IntermediateOutputPath)$(AntlrGenCodeFileNames);" />
</ItemGroup>

</Target>

