commit b4891851600e630dd9f0c90a5f95c91626797bc8
Author:     sharwell <sharwell@pixelminegames.com>
AuthorDate: Thu Aug 4 07:50:00 2011 -0800
Commit:     sharwell <sharwell@pixelminegames.com>
CommitDate: Thu Aug 4 07:50:00 2011 -0800

(C# 3) Test template frame depth to help prevent stack overflow exceptions

[git-p4: depot-paths = "//depot/code/antlrcs/main/": change = 8979]

diff --git a/Antlr4.StringTemplate/Interpreter.cs b/Antlr4.StringTemplate/Interpreter.cs
index f8414a1..f94ea87 100644
--- a/Antlr4.StringTemplate/Interpreter.cs
+++ b/Antlr4.StringTemplate/Interpreter.cs
@@ -156,13 +156,19 @@ namespace Antlr4.StringTemplate
{
try
{
+                if (frame.StackDepth > 200)
+                    throw new TemplateException("Template stack overflow.", null);
+
SetDefaultArguments(frame);
return ExecuteImpl(@out, frame);
}
catch (Exception e)
{
if (e.IsCritical())
+                {
+                    e.PreserveStackTrace();
throw;
+                }

StringBuilder builder = new StringBuilder();
builder.AppendLine(e.ToString());
diff --git a/Antlr4.StringTemplate/TemplateFrame.cs b/Antlr4.StringTemplate/TemplateFrame.cs
index 4fd015c..b5ab7a1 100644
--- a/Antlr4.StringTemplate/TemplateFrame.cs
+++ b/Antlr4.StringTemplate/TemplateFrame.cs
@@ -40,6 +40,7 @@ namespace Antlr4.StringTemplate
{
private readonly Template _template;
private readonly TemplateFrame _parent;
+        private readonly int _depth;
private int _ip;
private DebugEvents _debugState;

@@ -47,6 +48,8 @@ namespace Antlr4.StringTemplate
{
_template = template;
_parent = parent;
+
+            _depth = (parent != null) ? parent._depth + 1 : 1;
}

public Template Template
@@ -65,6 +68,14 @@ namespace Antlr4.StringTemplate
}
}

+        public int StackDepth
+        {
+            get
+            {
+                return _depth;
+            }
+        }
+
public int InstructionPointer
{
get

