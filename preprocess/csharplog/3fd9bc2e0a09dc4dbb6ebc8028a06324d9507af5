commit 3fd9bc2e0a09dc4dbb6ebc8028a06324d9507af5
Author:     sharwell <sharwell@pixelminegames.com>
AuthorDate: Mon Dec 14 01:52:07 2009 -0800
Commit:     sharwell <sharwell@pixelminegames.com>
CommitDate: Mon Dec 14 01:52:07 2009 -0800

C# Port:
* Merge CL 6400

[git-p4: depot-paths = "//depot/code/antlrcs/main/": change = 6508]

diff --git a/STViz/App.xaml b/STViz/App.xaml
index 91180a4..46d25cc 100644
--- a/STViz/App.xaml
+++ b/STViz/App.xaml
@@ -1,7 +1,6 @@
﻿<Application x:Class="STViz.App"
xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
-    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
-    StartupUri="Window1.xaml">
+    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
<Application.Resources>

</Application.Resources>
diff --git a/STViz/App.xaml.cs b/STViz/App.xaml.cs
index cb349a4..c12462e 100644
--- a/STViz/App.xaml.cs
+++ b/STViz/App.xaml.cs
@@ -41,5 +41,10 @@ namespace STViz

public partial class App : Application
{
+        protected override void OnStartup(StartupEventArgs e)
+        {
+            MainWindow = new TemplateVisualizer();
+            MainWindow.Show();
+        }
}
}
diff --git a/STViz/STViz.csproj b/STViz/STViz.csproj
index f58fb82..5768007 100644
--- a/STViz/STViz.csproj
+++ b/STViz/STViz.csproj
@@ -61,18 +61,10 @@
<Generator>MSBuild:Compile</Generator>
<SubType>Designer</SubType>
</ApplicationDefinition>
-    <Page Include="Window1.xaml">
-      <Generator>MSBuild:Compile</Generator>
-      <SubType>Designer</SubType>
-    </Page>
<Compile Include="App.xaml.cs">
<DependentUpon>App.xaml</DependentUpon>
<SubType>Code</SubType>
</Compile>
-    <Compile Include="Window1.xaml.cs">
-      <DependentUpon>Window1.xaml</DependentUpon>
-      <SubType>Code</SubType>
-    </Compile>
</ItemGroup>
<ItemGroup>
<Compile Include="Properties\AssemblyInfo.cs">
@@ -88,6 +80,9 @@
<DependentUpon>Settings.settings</DependentUpon>
<DesignTimeSharedInput>True</DesignTimeSharedInput>
</Compile>
+    <Compile Include="TemplateVisualizer.xaml.cs">
+      <DependentUpon>TemplateVisualizer.xaml</DependentUpon>
+    </Compile>
<EmbeddedResource Include="Properties\Resources.resx">
<Generator>ResXFileCodeGenerator</Generator>
<LastGenOutput>Resources.Designer.cs</LastGenOutput>
@@ -107,6 +102,12 @@
<Name>StringTemplate4</Name>
</ProjectReference>
</ItemGroup>
+  <ItemGroup>
+    <Page Include="TemplateVisualizer.xaml">
+      <Generator>MSBuild:Compile</Generator>
+      <SubType>Designer</SubType>
+    </Page>
+  </ItemGroup>
<Import Project="$(MSBuildToolsPath)\Microsoft.CSharp.targets" />
<!-- To modify your build process, add your task inside one of the targets below and uncomment it.
Other similar extension points exist, see Microsoft.Common.targets.
diff --git a/STViz/TemplateVisualizer.xaml b/STViz/TemplateVisualizer.xaml
index 9316cc4..c589ba5 100644
--- a/STViz/TemplateVisualizer.xaml
+++ b/STViz/TemplateVisualizer.xaml
@@ -1,4 +1,4 @@
-﻿<Window x:Class="STViz.Window1"
+﻿<Window x:Class="STViz.TemplateVisualizer"
xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
Title="StringTemplate Visualizer" Height="522" Width="591">
diff --git a/STViz/TemplateVisualizer.xaml.cs b/STViz/TemplateVisualizer.xaml.cs
index f768055..6885011 100644
--- a/STViz/TemplateVisualizer.xaml.cs
+++ b/STViz/TemplateVisualizer.xaml.cs
@@ -43,12 +43,29 @@ namespace STViz
using System.Windows.Media;
using StringTemplate.Debug;

-    public partial class Window1 : Window
+    public partial class TemplateVisualizer : Window
{
-        public Window1()
+        internal TemplateVisualizer()
+            : this(CreateDefaultTemplate())
+        {
+        }
+
+        public TemplateVisualizer(Template template)
{
InitializeComponent();

+            StringWriter sw = new StringWriter();
+            Interpreter interp = new Interpreter(template.groupThatCreatedThisInstance, new AutoIndentWriter(sw));
+            interp.Exec(template);
+            IList<InterpEvent> events = interp.Events;
+
+            string text = sw.ToString();
+            templatesTree.Items.Add(new RootEvent(template, 0, text.Length));
+            txtOutput.Document = new FlowDocument(new Paragraph(new Run(text)));
+        }
+
+        private static Template CreateDefaultTemplate()
+        {
string templates =
"method(type,name,args,stats) ::= <<\n" +
"public <type> <name>(<args:{a| int <a>}; separator=\", \">) {\n" +
@@ -84,14 +101,7 @@ namespace STViz
st.Add("stats", s2);
st.Add("stats", s3);

-            StringWriter sw = new StringWriter();
-            Interpreter interp = new Interpreter(group, new AutoIndentWriter(sw));
-            interp.Exec(st);
-            IList<InterpEvent> events = interp.Events;
-
-            string text = sw.ToString();
-            templatesTree.Items.Add(new RootEvent(st, 0, text.Length));
-            txtOutput.Document = new FlowDocument(new Paragraph(new Run(text)));
+            return st;
}

private void OnTextTemplateDataContextChanged(object sender, DependencyPropertyChangedEventArgs e)

