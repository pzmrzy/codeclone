commit 8fb35e46f8e0a969ff8b13e887f5cf4e96c29016
Author:     sharwell <sharwell@pixelminegames.com>
AuthorDate: Mon Jan 31 15:15:08 2011 -0800
Commit:     sharwell <sharwell@pixelminegames.com>
CommitDate: Mon Jan 31 15:15:08 2011 -0800

(C# 3) Merge CL7536

[git-p4: depot-paths = "//depot/code/antlrcs/main/": change = 7585]

diff --git a/Antlr3.vsmdi b/Antlr3.vsmdi
index 019f70c..48dffab 100644
--- a/Antlr3.vsmdi
+++ b/Antlr3.vsmdi
@@ -344,13 +344,14 @@
<TestLink id="fb99ea63-735d-3db2-e0dd-f0bde0dbc102" name="TestIndentBeforeRegionIsIgnored" storage="antlr4.test.stringtemplate\bin\debug\antlr4.test.stringtemplate.dll" type="Microsoft.VisualStudio.TestTools.TestTypes.Unit.UnitTestElement, Microsoft.VisualStudio.QualityTools.Tips.UnitTest.ObjectModel, Version=10.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" />
<TestLink id="9ee02534-0ce6-cb83-de5d-91557fd3473c" name="TestDefineRegionInSubgroup" storage="antlr4.test.stringtemplate\bin\debug\antlr4.test.stringtemplate.dll" type="Microsoft.VisualStudio.TestTools.TestTypes.Unit.UnitTestElement, Microsoft.VisualStudio.QualityTools.Tips.UnitTest.ObjectModel, Version=10.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" />
<TestLink id="5a579f7d-489b-39b2-ae73-8d0002da22d3" name="TestUnknownRegionDefError" storage="antlr4.test.stringtemplate\bin\debug\antlr4.test.stringtemplate.dll" type="Microsoft.VisualStudio.TestTools.TestTypes.Unit.UnitTestElement, Microsoft.VisualStudio.QualityTools.Tips.UnitTest.ObjectModel, Version=10.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" />
-      <TestLink id="25c79e77-a9dc-f77a-c3de-c85280cc9f3a" name="TestRegionOverrideRefSuperRegion3Levels" storage="antlr4.test.stringtemplate\bin\debug\antlr4.test.stringtemplate.dll" type="Microsoft.VisualStudio.TestTools.TestTypes.Unit.UnitTestElement, Microsoft.VisualStudio.QualityTools.Tips.UnitTest.ObjectModel, Version=10.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" />
+      <TestLink id="162a1b20-76d3-f55d-5e9d-8674677e8fc3" name="TestRegionOverrideRefSuperImplicitRegion" storage="antlr4.test.stringtemplate\bin\debug\antlr4.test.stringtemplate.dll" type="Microsoft.VisualStudio.TestTools.TestTypes.Unit.UnitTestElement, Microsoft.VisualStudio.QualityTools.Tips.UnitTest.ObjectModel, Version=10.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" />
<TestLink id="62229bd7-8afc-5de8-aef1-83e219e7f10d" name="TestDefineRegionInSubgroup2" storage="antlr4.test.stringtemplate\bin\debug\antlr4.test.stringtemplate.dll" type="Microsoft.VisualStudio.TestTools.TestTypes.Unit.UnitTestElement, Microsoft.VisualStudio.QualityTools.Tips.UnitTest.ObjectModel, Version=10.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" />
<TestLink id="db36848d-942b-93a5-f9d3-6d04413df643" name="TestDefineRegionInSameGroup" storage="antlr4.test.stringtemplate\bin\debug\antlr4.test.stringtemplate.dll" type="Microsoft.VisualStudio.TestTools.TestTypes.Unit.UnitTestElement, Microsoft.VisualStudio.QualityTools.Tips.UnitTest.ObjectModel, Version=10.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" />
<TestLink id="67214068-43a8-c38e-ba44-18f6f60c3ce9" name="TestCantDefineEmbeddedRegionAgain" storage="antlr4.test.stringtemplate\bin\debug\antlr4.test.stringtemplate.dll" type="Microsoft.VisualStudio.TestTools.TestTypes.Unit.UnitTestElement, Microsoft.VisualStudio.QualityTools.Tips.UnitTest.ObjectModel, Version=10.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" />
<TestLink id="a287f385-a0e1-a876-5742-1a0d5d8942c6" name="TestSuperRegionRefMissingOk" storage="antlr4.test.stringtemplate\bin\debug\antlr4.test.stringtemplate.dll" type="Microsoft.VisualStudio.TestTools.TestTypes.Unit.UnitTestElement, Microsoft.VisualStudio.QualityTools.Tips.UnitTest.ObjectModel, Version=10.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" />
+      <TestLink id="0b09b3e4-fab0-d6b3-22ba-f73ce6919550" name="TestRegionOverrideStripsNewlines" storage="antlr4.test.stringtemplate\bin\debug\antlr4.test.stringtemplate.dll" type="Microsoft.VisualStudio.TestTools.TestTypes.Unit.UnitTestElement, Microsoft.VisualStudio.QualityTools.Tips.UnitTest.ObjectModel, Version=10.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" />
<TestLink id="3b975616-c6e9-f9a3-5992-22d3a0c18e20" name="TestEmbeddedRegion" storage="antlr4.test.stringtemplate\bin\debug\antlr4.test.stringtemplate.dll" type="Microsoft.VisualStudio.TestTools.TestTypes.Unit.UnitTestElement, Microsoft.VisualStudio.QualityTools.Tips.UnitTest.ObjectModel, Version=10.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" />
-      <TestLink id="162a1b20-76d3-f55d-5e9d-8674677e8fc3" name="TestRegionOverrideRefSuperImplicitRegion" storage="antlr4.test.stringtemplate\bin\debug\antlr4.test.stringtemplate.dll" type="Microsoft.VisualStudio.TestTools.TestTypes.Unit.UnitTestElement, Microsoft.VisualStudio.QualityTools.Tips.UnitTest.ObjectModel, Version=10.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" />
+      <TestLink id="25c79e77-a9dc-f77a-c3de-c85280cc9f3a" name="TestRegionOverrideRefSuperRegion3Levels" storage="antlr4.test.stringtemplate\bin\debug\antlr4.test.stringtemplate.dll" type="Microsoft.VisualStudio.TestTools.TestTypes.Unit.UnitTestElement, Microsoft.VisualStudio.QualityTools.Tips.UnitTest.ObjectModel, Version=10.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" />
</TestLinks>
</TestList>
<TestList name="Groups" id="2b84a5ba-a6b2-44f6-842f-39aeaec2d3f0" parentListId="4adbb104-d28d-4362-8420-a9fefe69c167">
diff --git a/Antlr4.StringTemplate/TemplateGroup.cs b/Antlr4.StringTemplate/TemplateGroup.cs
index 33d0867..9ae0485 100644
--- a/Antlr4.StringTemplate/TemplateGroup.cs
+++ b/Antlr4.StringTemplate/TemplateGroup.cs
@@ -362,6 +362,8 @@ namespace Antlr4.StringTemplate
string template)
{
string name = regionT.Text;
+            template = Utility.TrimOneStartingNewline(template);
+            template = Utility.TrimOneTrailingNewline(template);
CompiledTemplate code = Compile(FileName, enclosingTemplateName, null, template, regionT);
string mangled = GetMangledRegionName(enclosingTemplateName, name);

diff --git a/Antlr4.Test.StringTemplate/TestRegions.cs b/Antlr4.Test.StringTemplate/TestRegions.cs
index 1e080a4..203b281 100644
--- a/Antlr4.Test.StringTemplate/TestRegions.cs
+++ b/Antlr4.Test.StringTemplate/TestRegions.cs
@@ -178,6 +178,40 @@ namespace Antlr4.Test.StringTemplate
Assert.AreEqual(expected, result);
}

+        [TestMethod]
+        public void TestRegionOverrideStripsNewlines()
+        {
+            TemplateGroup.debug = true;
+
+            string dir = tmpdir;
+            string g =
+                    "a() ::= \"X<@r()>Y\"" +
+                    "@a.r() ::= <<\n" +
+                    "foo\n" +
+                    ">>\n";
+            writeFile(dir, "g.stg", g);
+
+            TemplateGroupFile group = new TemplateGroupFile(Path.Combine(dir, "g.stg"));
+            string sub = "@a.r() ::= \"A<@super.r()>B\"" + newline;
+            writeFile(dir, "sub.stg", sub);
+            TemplateGroupFile subGroup = new TemplateGroupFile(Path.Combine(dir, "sub.stg"));
+            subGroup.ImportTemplates(group);
+            Template st = subGroup.GetInstanceOf("a");
+            string result = st.Render();
+
+            Template st2 = group.GetInstanceOf("region__a__r");
+            st2.impl.Dump();
+            System.IO.StringWriter writer = new System.IO.StringWriter();
+            ITemplateWriter wr = new AutoIndentWriter(writer);
+            Interpreter interp = new Interpreter(st.groupThatCreatedThisInstance, System.Globalization.CultureInfo.CurrentCulture);
+            interp.Execute(wr, st); // Render and track events
+            foreach (var line in interp.GetExecutionTrace())
+                System.Console.Error.WriteLine(line);
+
+            string expecting = "XAfooBY";
+            Assert.AreEqual(expecting, result);
+        }
+
//

[TestMethod]

