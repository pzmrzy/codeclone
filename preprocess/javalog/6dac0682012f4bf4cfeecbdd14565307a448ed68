commit 6dac0682012f4bf4cfeecbdd14565307a448ed68
Author:     Sam Harwell <sam@tunnelvisionlabs.com>
AuthorDate: Tue Feb 5 13:10:17 2013 -0600
Commit:     Sam Harwell <sam@tunnelvisionlabs.com>
CommitDate: Tue Feb 5 13:10:40 2013 -0600

Fix IntervalSet.add when multiple merges are required

diff --git a/tool/src/main/java/org/antlr/misc/IntervalSet.java b/tool/src/main/java/org/antlr/misc/IntervalSet.java
index a2af56f..0dd14c1 100644
--- a/tool/src/main/java/org/antlr/misc/IntervalSet.java
+++ b/tool/src/main/java/org/antlr/misc/IntervalSet.java
@@ -116,14 +116,17 @@ public class IntervalSet implements IntSet {
iter.set(bigger);
// make sure we didn't just create an interval that
// should be merged with next interval in list
-				if ( iter.hasNext() ) {
+				while ( iter.hasNext() ) {
Interval next = iter.next();
-					if ( bigger.adjacent(next)||!bigger.disjoint(next) ) {
-						// if we bump up against or overlap next, merge
-						iter.remove();   // remove this one
-						iter.previous(); // move backwards to what we just set
-						iter.set(bigger.union(next)); // set to 3 merged ones
+					if ( !bigger.adjacent(next) && bigger.disjoint(next) ) {
+						break;
}
+
+					// if we bump up against or overlap next, merge
+					iter.remove();   // remove this one
+					iter.previous(); // move backwards to what we just set
+					iter.set(bigger.union(next)); // set to 3 merged ones
+					iter.next(); // first call to next after previous duplicates the result
}
return;
}

